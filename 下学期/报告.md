# Elasticsearch 远程代码执行漏洞（CVE-2015-1427） 利用检测与修复缓解报告


## 一、漏洞概述
**漏洞编号：** CVE-2015-1427

**影响版本：** Elasticsearch 1.3.0 ≤ 版本 ≤ 1.3.8，1.4.0 ≤ 版本 ≤ 1.4.2

**漏洞类型：** 远程代码执行（RCE）

**漏洞描述：** 在受影响版本中，Elasticsearch 默认支持 Groovy 脚本执行。如果攻击者通过 REST 接口注入恶意脚本，可在服务器上执行任意 Java 代码，进而远程获取主机控制权。






## 二、实验环境


**平台：** Vulfocus 靶场环境

**镜像：** vulfocus/elasticsearch-cve_2015_1427:latest

**攻击机：**Kali + Metasploit

**目标IP：**192.168.107.16

**攻击机IP：** 192.168.107.9


## 三.漏洞检测
**抓容器流量并保存**
```
sudo tcpdump -i br-18123ea75823 host 172.19.0.2 -w /tmp/container_traffic.pcap

```
![](./抓容器流量.png)

### **将文件导出并进行分析** 
```
scp kali@192.168.107.16:/tmp/container_traffic.pcap .
```
![](./导出.png)

由于我们知道该攻击是在9200端口进行攻击我们通过筛选
```
tcp.port == 9200 && http.request.method == "POST"
```
得到
![](./筛选2.png)

选择可疑的http包找到追踪流
![](./找到追踪流.png)
![](./追踪六.png)
#### **通过追踪流可得到**
**请求部分：** script_fields：用于执行自定义 Groovy 脚本，这是该漏洞的利用点

**script内容：** 使用 java.lang.Math.class.forName("java.lang.Runtime") 反射方式访问 Runtime 类，为后续执行 exec() 铺垫

**lang: groovy：**	指定脚本语言为 Groovy

**检测**：这段请求内容看起来像是 Elasticsearch 的一个利用示例，涉及通过脚本字段（script_fields）执行Java反射类的调用，从而写入恶意文件到服务器临时目录（/tmp/qAHnhR.jar），属于典型的Elasticsearch远程代码执行（RCE）漏洞利用场景。



#### **通过响应部分可得到**
服务端返回了 class java.lang.Runtime，说明攻击者成功访问了 Runtime 类


**由此可得到完成攻击**


## 四，漏洞修复
根据上述内容和网上查阅的资料可得知该漏洞是通过执行 Groovy 动态脚本进行攻击，所以可以通过修改配置禁用 Groovy来阻止这个攻击从而完成修复

**我们打开容器并修改其配置文件**
![](./修改过程.png)

**重新执行攻击**
![](./攻击失败.png)
攻击失败，漏洞修复成功